# PGChecker


## Introduction

The PGChecker is a tool to identify violations against the self-consistent MPI 
performance guidelines using the performance profiles generated by the PGTuneLib library. 
It provides multiple comparators that perform different evaluation of the raw runtime data.

# References 

- Sascha Hunold:
  Verifying Performance Guidelines for MPI Collectives at Scale. SC Workshops 2023: 1264-1268

## Installation

`pgchecker` depends on [`pgmpitunelib`](https://github.com/hunsa/pgmpitunelib).

Therefore, the steps to build `pgchecker` are:
1. Build and install `pgmpitunelib`
2. Build `pgchecker` on top of `pgmpitunelib`

Let us assume, we are in directory `~/tmp/reprobeta`, where we will install everything.

1. Install `pgmpitunelib`
```bash
cd ~/tmp/reprobeta
git clone https://github.com/hunsa/pgmpitunelib.git
cd pgmpitunelib
cmake -DCMAKE_INSTALL_PREFIX=$HOME/tmp/reprobeta/build -B build
cmake --build ./build/ -v
cmake --install ./build/ 
```
Now, `pgmpitunelib` should be installed in `$HOME/tmp/reprobeta/build`.

2. Install `pgchecker`
```bash
git clone https://github.com/hunsa/reprompi.git
cd reprompi
cmake -DOPTION_ENABLE_PGCHECKER=ON -DPGTUNELIB_PATH=$HOME/tmp/reprobeta/build -B build
cmake --build ./build/ -v
```
Now, `pgchecker` is available in `build\bin`.

3. Configure `pgchecker`
All available collectives are part of `pgmpitunelib`, which contains an executable `pgmpi_info` which print all collectives in CSV format.

We will create a CSV with all these collectives like so:
```bash
$HOME/tmp/reprobeta/build/bin/pgmpi_info > collectives.csv
```
The file should look like this:
``bash
head -5 collectives.csv
cliname;mpiname;algname;rooted
allgather;MPI_Allgather;default;0
allgather;MPI_Allgather;allgather_as_allgatherv;0
allgather;MPI_Allgather;allgather_as_allreduce;0
allgather;MPI_Allgather;allgather_as_alltoall;0
```
You can edit this file, e.g., you can remove lines that should no be tested. Otherwise, the file can just be used as is:
```bash
PGCHECKER_CSV=./collectives.csv srun --mpi=pmi2 -N32 --ntasks-per-node=32 ./build/bin/pgchecker -o ./foo -d -f ./examples/pgcheck/input.txt 
```
The `input.txt` what and how to test each collective version, which defines all parameters that `reprompi` should use to run each collective. So, this file has the format
```bash
collective_name reprompi_parameters
```

For example:
```bash
cat ./examples/pgcheck/input.txt 
MPI_Allreduce --msizes-list=8,80,800,8000,80000 --nrep=5000 --proc-sync=roundtime --rt-bench-time-ms=3000 --rt-barrier-count=0
```



## Running the PGChecker

In the simplest use case, PGChecker can simply be given an input file listing all collective operations to be tested.

```
mpirun -np 4 ./bin/pgchecker -f input.txt
```

The input file contains a list of operations to be tested. In each line of the file the collective function to be tested, a (list of) message sizes and the *number of measurement repetitions* for each test are specified, as in the following example.

```
MPI_Bcast       --msizes-list=1024,4096,16384 --nrep=500 --proc-sync=roundtime --rt-bench-time-ms=2000 --rt-barrier-count=0
MPI_Allreduce   --msizes-list=1024,4096,16384 --nrep=500 --proc-sync=roundtime --rt-bench-time-ms=2000 --rt-barrier-count=0
```


## Command-line Options

### Common Options

- `-h` | `--help` print help.
- `-v` | `--verbose` print all evaluations.
- `-f` | `--input=<path>` input file containing the list of benchmarking jobs (tuples of MPI function, message size, number of repetitions).
- `-o` | `--output` print evaluations to output folder.
- `-s` | `--csv` print evaluations as `.csv`-file to output folder.
- `-m` | `--merge` merge tables of all tested MPI functions and print.
- `-d` | `--allow-mkdir` create folder in the output folder for every comparer.
- `-t` | `--test` statistical test used for identification of violations against the performance guidelines. Possible values are: TTest(=0), WilcoxonRankSum(=1), and WilcoxonMannWhitney(=2). Default is TTest.
- `-c` | `--comp-list` a list of comparer seperated by `,`. Possible values are: Simple(=0), AbsRuntime(=1), RelRuntime(=2), Violation(=3), DetailedViolation(=4), GroupedViolation(=5), Raw(=6). Default is Raw.

### Comparer
| **Comparer**     | **Raw** | **Absolute Runtime** | **Relative Runtime** | **Violation** | **Detailed Violation** | **Grouped Violation** | **Simple** |
|------------------|:-------:|:--------------------:|:--------------------:|:-------------:|:----------------------:|:---------------------:|:----------:|
| Runtime          |  **x**  |                      |                      |               |                        |                       |            |
| Default Mean     |         |                      |                      |     **x**     |          **x**         |                       |    **x**   |
| Mockup Mean      |         |                      |                      |     **x**     |          **x**         |                       |    **x**   |
| Default Median   |         |         **x**        |                      |     **x**     |          **x**         |         **x**         |            |
| Mockup Median    |         |         **x**        |                      |     **x**     |          **x**         |         **x**         |            |
| Default / Mockup |         |                      |         **x**        |               |          **x**         |         **x**         |            |
| N, ppn           |         |                      |                      |     **x**     |          **x**         |         **x**         |            |
| z-Value          |         |                      |                      |     **x**     |          **x**         |                       |            |
| critical-Value   |         |                      |                      |     **x**     |          **x**         |                       |            |
| Violation        |         |                      |                      |     **x**     |          **x**         |         **x**         |            |
| Barrier Warning  |         |                      |                      |     **x**     |          **x**         |         **x**         |            |
| Fastest Mockup   |         |                      |                      |               |                        |         **x**         |            |
| Count Violations |         |                      |                      |     **x**     |          **x**         |         **x**         |            |
### Statistical Tests

| **Test**                  | **Mean** |  **Median**  |  **Bounded Ranks**  |
|---------------------------|:--------:|:------------:|:-------------------:|
| **T-Test**                |  **x**   |              |                     |
| **Wilcoxon Rank-Sum**     |          |    **x**     |                     |
| **Wilcoxon-Mann-Whitney** |          |    **x**     |        **x**        |


